spend_breakdown(df, varname)
ggsave(file.path(FIGDIR, fn), height = 10, width = 20, units = "cm")
ylabs <- list(
tag = "Spending category (9)",
tag_spend = "Spending category (48)"
)
spend_breakdown <- function(data, varname) {
data %>%
sample_frac(0.001) %>%
select(matches(glue("^(ct|sp)_{varname}(?!_spend)(?!_cash)"), perl = T)) %>%
rowwise() %>%
mutate(
across(starts_with("sp"), ~.x / sum(c_across(starts_with("sp_")))),
across(starts_with("ct"), ~.x / sum(c_across(starts_with("ct_"))))
) %>%
ungroup() %>%
summarise(across(everything(), mean)) %>%
pivot_longer(everything()) %>%
extract(name, c("metric", "name"), "(sp|ct)_(.*)") %>%
pivot_wider(names_from = metric, values_from = value) %>%
arrange(desc(sp)) %>%
head(15) %>%
pivot_longer(!name, names_to = "metric", values_to = "value") %>%
rowwise() %>%
mutate(name = factor(taglabs[[name]])) %>%
ggplot(aes(value, reorder(name, desc(name)), colour = metric)) +
geom_point() +
scale_colour_discrete(breaks=c("ct", "sp"), labels=c("Txns", "Spend")) +
scale_x_continuous(labels = scales::percent) +
labs(
x = "Percentage of monthly spend/number of txns",
y = ylabs[[y]]
) +
theme(legend.title = element_blank(), legend.position = c(0.9, 0.1))
}
varname <- "tag"
fn <- glue("breakdown_{varname}.pdf")
spend_breakdown(df, varname)
spend_breakdown <- function(data, varname) {
data %>%
sample_frac(0.001) %>%
select(matches(glue("^(ct|sp)_{varname}(?!_spend)(?!_cash)"), perl = T)) %>%
rowwise() %>%
mutate(
across(starts_with("sp"), ~.x / sum(c_across(starts_with("sp_")))),
across(starts_with("ct"), ~.x / sum(c_across(starts_with("ct_"))))
) %>%
ungroup() %>%
summarise(across(everything(), mean)) %>%
pivot_longer(everything()) %>%
extract(name, c("metric", "name"), "(sp|ct)_(.*)") %>%
pivot_wider(names_from = metric, values_from = value) %>%
arrange(desc(sp)) %>%
head(15) %>%
pivot_longer(!name, names_to = "metric", values_to = "value") %>%
rowwise() %>%
mutate(name = factor(taglabs[[name]])) %>%
ggplot(aes(value, reorder(name, desc(name)), colour = metric)) +
geom_point() +
scale_colour_discrete(breaks=c("ct", "sp"), labels=c("Txns", "Spend")) +
scale_x_continuous(labels = scales::percent) +
labs(
x = "Percentage of monthly spend/number of txns",
y = ylabs[[varname]]
) +
theme(legend.title = element_blank(), legend.position = c(0.9, 0.1))
}
varname <- "tag"
fn <- glue("breakdown_{varname}.pdf")
spend_breakdown(df, varname)
ggsave(file.path(FIGDIR, fn), height = 10, width = 20, units = "cm")
varname <- "tag_spend"
fn <- glue("breakdown_{varname}.pdf")
spend_breakdown(df, varname)
ggsave(file.path(FIGDIR, fn), height = 10, width = 20, units = "cm")
df
df %>%
mutate(entropy_tag_q = ntile(entropy_tag, 5)) %>%
select(entropy_tag_q, matches("$ct_entropy_tag_(?!spend)", perl = T)) %>%
group_by(entropy_tag_q) %>%
summarise(across(everything(), mean))
df %>%
mutate(entropy_tag_q = ntile(entropy_tag, 5)) %>%
select(entropy_tag_q, matches("$ct_entropy_tag_(?!spend)", perl = T))
df %>%
mutate(entropy_tag_q = ntile(entropy_tag, 5)) %>%
select(entropy_tag_q, matches("$ct_entropy_tag_(?!spend)", perl = T)) %>%
summary()
df %>%
mutate(entropy_tag_q = ntile(entropy_tag, 5)) %>%
select(entropy_tag_q, matches("$ct_tag_(?!spend)", perl = T)) %>%
summary()
df %>%
mutate(entropy_tag_q = ntile(entropy_tag, 5)) %>%
select(entropy_tag_q, matches("^ct_tag_(?!spend)", perl = T)) %>%
summary()
df %>%
mutate(entropy_tag_q = ntile(entropy_tag, 5)) %>%
select(entropy_tag_q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(entropy_tag_q) %>%
summarise(across(everything(), mean))
df %>%
mutate(q = ntile(entropy_tag, 5)) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q)
df %>%
mutate(q = ntile(entropy_tag, 5)) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(value, reorder(name, desc(value)))) +
geom_bar()
df %>%
mutate(q = ntile(entropy_tag, 5)) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(value, reorder(name, desc(value)))) +
geom_point()
df %>%
mutate(q = ntile(entropy_tag, 5)) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(value, reorder(name, desc(value)))) +
geom_bar(stat = "identity")
df %>%
mutate(q = ntile(entropy_tag, 5)) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(value, reorder(name, desc(value)), fill = q)) +
geom_bar(stat = "identity")
?geom_bar
df %>%
mutate(q = ntile(entropy_tag, 5)) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(value, reorder(name, desc(value)), fill = q)) +
geom_bar(stat = "identity", position = "dodge")
df %>%
mutate(q = ntile(entropy_tag, 5)) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(value, reorder(name, desc(value)), fill = q)) +
geom_bar(stat = "identity", position = "dodge")
df %>%
mutate(q = ntile(entropy_tag, 5)) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(value, reorder(factor(name), desc(value)), fill = q)) +
geom_bar(stat = "identity", position = "dodge")
df %>%
mutate(q = ntile(entropy_tag, 5)) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(value, factor(reorder(name, desc(value))), fill = q)) +
geom_bar(stat = "identity", position = "dodge")
df %>%
mutate(q = factor(ntile(entropy_tag, 5))) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(value, reorder(name, desc(value)), fill = q)) +
geom_bar(stat = "identity", position = "dodge")
df %>%
mutate(q = factor(ntile(entropy_tag, 3))) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(value, reorder(name, desc(value)), fill = q)) +
geom_bar(stat = "identity", position = "dodge")
df %>%
mutate(q = factor(ntile(entropy_tag_spend, 3))) %>%
select(q, matches("^ct_tag_spend", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(value, reorder(name, desc(value)), fill = q)) +
geom_bar(stat = "identity", position = "dodge")
df %>%
mutate(q = factor(ntile(entropy_tag_spend, 3))) %>%
select(q, matches("^ct_tag_spend", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge")
df %>%
mutate(q = factor(ntile(entropy_tag, 3))) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge")
df %>%
mutate(q = factor(ntile(entropy_tag, 3))) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
theme(axis.text.x = element_blank())
df %>%
mutate(q = factor(ntile(entropy_tag, 5 ))) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
lab(fill = "Entropy quintile")
df %>%
mutate(q = factor(ntile(entropy_tag, 5))) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
lab(fill = "Entropy quintile")
df %>%
mutate(q = factor(ntile(entropy_tag, 5))) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
lab(fill = "Entropy quintile") +
theme(axis.text.x = element_blank())
df %>%
mutate(q = factor(ntile(entropy_tag, 5))) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(fill = "Entropy quintile") +
theme(axis.text.x = element_blank())
df %>%
mutate(q = factor(ntile(entropy_tag, 5))) %>%
select(q, matches("^sp_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(fill = "Entropy quintile") +
theme(axis.text.x = element_blank())
df %>%
mutate(q = factor(ntile(entropy_tag, 5))) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(fill = "Entropy quintile") +
theme(axis.text.x = element_blank())
df %>%
mutate(q = factor(ntile(entropy_tag, 5))) %>%
select(q, matches("^ct_tag_(?!spend)", perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
filter(q %in% c(1, 3, 5)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(fill = "Entropy quintile") +
theme(axis.text.x = element_blank())
spend_profile <- function(data, varname) {
data %>%
mutate(q = factor(ntile(.data[[glue("entropy_{varname}")]], 5))) %>%
select(q, matches(glue("^ct_{varname}_(?!spend)"), perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
filter(q %in% c(1, 3, 5)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(fill = "Entropy quintile") +
theme(axis.text.x = element_blank())
}
varname <- "tag_spend"
fn <- glue("spend_profile_{varname}.pdf")
spend_profile(df, varname)
data %>%
mutate(q = factor(ntile(.data[[glue("entropy_{varname}")]], 5))) %>%
select(q, matches(glue("^ct_{varname}_(?!spend)"), perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
filter(q %in% c(1, 3, 5)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(fill = "Entropy quintile") +
theme(
axis.text.x = element_blank(),
legend.position = c(0.9, 0.9)
)
spend_profile <- function(data, varname) {
data %>%
mutate(q = factor(ntile(.data[[glue("entropy_{varname}")]], 5))) %>%
select(q, matches(glue("^ct_{varname}_(?!spend)"), perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
filter(q %in% c(1, 3, 5)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(fill = "Entropy quintile") +
theme(
axis.text.x = element_blank(),
legend.position = c(0.9, 0.9)
)
}
varname <- "tag_spend"
fn <- glue("spend_profile_{varname}.pdf")
spend_profile(df, varname)
data %>%
mutate(q = factor(ntile(.data[[glue("entropy_{varname}")]], 5))) %>%
select(q, matches(glue("^ct_{varname}_(?!spend)"), perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
filter(q %in% c(1, 3, 5)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(fill = "Entropy\mquintile") +
spend_profile <- function(data, varname) {
data %>%
mutate(q = factor(ntile(.data[[glue("entropy_{varname}")]], 5))) %>%
select(q, matches(glue("^ct_{varname}_(?!spend)"), perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
filter(q %in% c(1, 3, 5)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(fill = "Entropy \n quintile") +
theme(
axis.text.x = element_blank(),
legend.position = c(0.9, 0.9)
)
}
varname <- "tag_spend"
fn <- glue("spend_profile_{varname}.pdf")
spend_profile(df, varname)
spend_profile <- function(data, varname) {
data %>%
mutate(q = factor(ntile(.data[[glue("entropy_{varname}")]], 5))) %>%
select(q, matches(glue("^ct_{varname}_(?!spend)"), perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
filter(q %in% c(1, 3, 5)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(fill = "Entropy\nquintile") +
theme(
axis.text.x = element_blank(),
legend.position = c(0.9, 0.9)
)
}
varname <- "tag_spend"
fn <- glue("spend_profile_{varname}.pdf")
spend_profile(df, varname)
spend_profile <- function(data, varname) {
data %>%
mutate(q = factor(ntile(.data[[glue("entropy_{varname}")]], 5))) %>%
select(q, matches(glue("^ct_{varname}_(?!spend)"), perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
filter(q %in% c(1, 3, 5)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(
x = "Spending category",
y = "Average number of transactions",
fill = "Entropy\nquintile"
) +
theme(
axis.text.x = element_blank(),
legend.position = c(0.9, 0.9)
)
}
varname <- "tag_spend"
fn <- glue("spend_profile_{varname}.pdf")
spend_profile(df, varname)
ggsave(file.path(FIGDIR, fn), height = 10, width = 20, units = "cm")
varname <- "tag"
fn <- glue("spend_profile_{varname}.pdf")
spend_profile(df, varname)
ggsave(file.path(FIGDIR, fn), height = 10, width = 20, units = "cm")
spend_profile <- function(data, varname) {
data %>%
mutate(q = factor(ntile(.data[[glue("entropy_{varname}")]], 5))) %>%
select(q, matches(glue("^ct_{varname}_(?!spend)"), perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
filter(q %in% c(1, 3, 5)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(
x = "Spending category",
y = "Average number of transactions",
fill = "Entropy\nquintile"
) +
theme(
axis.text.x = element_blank(),
legend.position = c(0.9, 0.8)
)
}
varname <- "tag_spend"
fn <- glue("spend_profile_{varname}.pdf")
spend_profile(df, varname)
ggsave(file.path(FIGDIR, fn), height = 10, width = 20, units = "cm")
varname <- "tag"
fn <- glue("spend_profile_{varname}.pdf")
spend_profile(df, varname)
ggsave(file.path(FIGDIR, fn), height = 10, width = 20, units = "cm")
spendlabs <- list(
tag = "Spending category (9)",
tag_spend = "Spending category (48)"
)
spend_breakdown <- function(data, varname) {
data %>%
sample_frac(0.001) %>%
select(matches(glue("^(ct|sp)_{varname}(?!_spend)(?!_cash)"), perl = T)) %>%
rowwise() %>%
mutate(
across(starts_with("sp"), ~.x / sum(c_across(starts_with("sp_")))),
across(starts_with("ct"), ~.x / sum(c_across(starts_with("ct_"))))
) %>%
ungroup() %>%
summarise(across(everything(), mean)) %>%
pivot_longer(everything()) %>%
extract(name, c("metric", "name"), "(sp|ct)_(.*)") %>%
pivot_wider(names_from = metric, values_from = value) %>%
arrange(desc(sp)) %>%
head(15) %>%
pivot_longer(!name, names_to = "metric", values_to = "value") %>%
rowwise() %>%
mutate(name = factor(taglabs[[name]])) %>%
ggplot(aes(value, reorder(name, desc(name)), colour = metric)) +
geom_point() +
scale_colour_discrete(breaks=c("ct", "sp"), labels=c("Txns", "Spend")) +
scale_x_continuous(labels = scales::percent) +
labs(
x = "Percentage of monthly spend/number of txns",
y = spendlabs[[varname]]
) +
theme(legend.title = element_blank(), legend.position = c(0.9, 0.1))
}
varname <- "tag"
fn <- glue("breakdown_{varname}.pdf")
spend_breakdown(df, varname)
ggsave(file.path(FIGDIR, fn), height = 10, width = 20, units = "cm")
varname <- "tag_spend"
fn <- glue("breakdown_{varname}.pdf")
spend_breakdown(df, varname)
ggsave(file.path(FIGDIR, fn), height = 10, width = 20, units = "cm")
spend_profile <- function(data, varname) {
data %>%
mutate(q = factor(ntile(.data[[glue("entropy_{varname}")]], 5))) %>%
select(q, matches(glue("^ct_{varname}_(?!spend)"), perl = T)) %>%
group_by(q) %>%
summarise(across(everything(), mean)) %>%
filter(q %in% c(1, 3, 5)) %>%
pivot_longer(!q) %>%
ggplot(aes(reorder(name, desc(value)), value, fill = q)) +
geom_bar(stat = "identity", position = "dodge") +
labs(
x = spendlabs[[varname]],
y = "Average number of transactions",
fill = "Entropy\nquintile"
) +
theme(
axis.text.x = element_blank(),
legend.position = c(0.9, 0.8)
)
}
varname <- "tag_spend"
fn <- glue("spend_profile_{varname}.pdf")
spend_profile(df, varname)
ggsave(file.path(FIGDIR, fn), height = 10, width = 20, units = "cm")
varname <- "tag"
fn <- glue("spend_profile_{varname}.pdf")
spend_profile(df, varname)
ggsave(file.path(FIGDIR, fn), height = 10, width = 20, units = "cm")
